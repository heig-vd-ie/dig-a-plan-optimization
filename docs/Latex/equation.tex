 \documentclass{article}
 \usepackage{amsmath}
 \usepackage{amssymb}
 \usepackage{geometry}
 \usepackage{array} 







% \usepackage{tikz}
% \usetikzlibrary{shapes.geometric, arrows.meta, positioning}

% \geometry{margin=1in}

% % Define TikZ styles
% \tikzset{
%   block/.style = {rectangle, draw, minimum height=1.2cm, minimum width=2.8cm, text centered},
%   decision/.style = {diamond, draw, aspect=2, minimum height=1.2cm, minimum width=2.8cm, text centered},
%   arrow/.style = {->, >=latex, thick},
%   startstop/.style = {circle, draw, minimum size=0.8cm, text centered}
% }


\usepackage{tikz}
\usetikzlibrary{arrows.meta, positioning, shapes.geometric, shapes.multipart}

\tikzstyle{startstop} = [ellipse, draw, minimum height=1cm, text width=3cm, align=center]

\tikzstyle{arrow}     = [thick, ->, >=Stealth]

\tikzstyle{block}     = [rectangle, draw, minimum height=1cm, text width=2.2cm, align=center]
\tikzstyle{decision}  = [diamond, draw, aspect=1, text width=1.5cm, align=center]

\begin{document}

\section*{Main Formulation}

\begin{equation}
\min \sum_{t }\sum_{i \in \mathcal{N}} \sum_{j \in \Delta_i} \sum_{\omega \in \Omega} \left\{ \frac{1}{2|\Omega|} \left( r_{ij}(\omega ,t ) I_{ij}(\omega ,t ) \right) \right\}
\tag{1}
\end{equation}


\begin{itemize}
    \item We have current in both directions, so we divide by 2 for loss.
\end{itemize}

Where:
\begin{align*}
\mathcal{N} &= \{1, 2, \ldots, i, \ldots, N\} \quad \text{set of nodes}, \\
\Delta_i &= \left\{ j = l, \ldots, k \right\} \quad \text{set of neighboring nodes of node } i, \\
\Omega &= \{1, 2, \ldots, \omega, \ldots, \bar{\Omega}\} \quad \text{set of scenarios}, \\
r_{ij}(\omega ,t ) &= \text{resistance of the line between node } i \text{ and } j \text{ in scenario } \omega  \text{ and time t }, \\
I_{ij}(\omega ,t ) &= \text{squared current between nodes } i \text{ and } j \text{ in scenario } \omega  \text{ and time t }.
\end{align*}



\subsection*{Subject to: DistFlow Constraints for specific time t}

\begin{align}
    \sum_{k \in \Delta_i} P_{ik}(\omega ,t )&= P_{i}(\omega ,t ) - u_iP_{Gi}(\omega ,t )
    && \forall i \in \mathcal{N}, \omega \in \Omega \tag{2a} \\
    \sum_{k \in \Delta_i} Q_{ik}(\omega ,t ) &= Q_{i}(\omega ,t ) - u_iQ_{Gi}(\omega ,t )
    && \forall i \in \mathcal{N}, \omega \in \Omega \tag{2b} \\
    I_{ij}(\omega ,t ) V_{i}(\omega ,t ) &\geq (P_{ij}(\omega ,t ))^2 + (Q_{ij}(\omega ,t ))^2 
    && \forall i \in \mathcal{N}, \forall j \in \Delta_i, \forall \omega \in \Omega \tag{2c} \\
    V_{i}(\omega ,t )- V_{j}(\omega ,t ) - 2 (r_{ij} P_{ij}(\omega ,t ) + x_{ij} Q_{ij}(\omega ,t )) 
    &+ (r_{ij}^2 + x_{ij}^2) I_{ij}(\omega ,t ) = 0
    && \forall i \in \mathcal{N}, \forall j \in \Delta_i, \forall \omega \in \Omega \tag{2d}
\end{align}

Where:

\begin{itemize}
    \item $u_i$: defines if node $i$ is HV/MV substation (parameter)
    \item $P_{i}(\omega ,t ), Q_{i}(\omega ,t )$: power generated by external grid
    \item $P_{ik}(\omega ,t )$: active power flow from node $i$ to node $k$ at scenario $\omega$
    
    \[
    \begin{array}{ccc}
    P_{ik}(\omega ,t ) \geq 0 & \Rightarrow & \text{flow from } i \text{ to } k \\
    P_{ki}(\omega ,t ) \leq 0 & \Rightarrow & \text{flow from } k \text{ to } i \\
    \end{array}
    \]

    \item $Q_{ik}(\omega ,t )$: reactive power from node $i$ to node $k$
    \item $V_{i}(\omega ,t )$: square of voltage at node $i$
    \item $x_{ij}$: reactance of the line from node $i$ to node $j$
    \item $P_{i}(\omega ,t )$: net consumption at node $i$
\end{itemize}

\subsection*{Radiality of Distribution Network}

\paragraph{Index sets.}
\[
\begin{aligned}
&N: \text{set of buses (nodes)},\\
&L: \text{set of undirected lines (edges)},\\
&S \subseteq L: \text{subset of lines equipped with switches},\\
&nS = L\setminus S: \text{lines without switches},\\
&C \subseteq L\times N\times N: \{(\ell,i,j)\} 
  \text{ directed candidate arcs for each line.}
\end{aligned}
\]

\paragraph{Parameters.}
\[
\begin{aligned}
&\texttt{slack\_node}\in N: \text{index of the root (slack) bus},\\
&\varepsilon>0: \text{small constant (default 1) for numerical stability}.
\end{aligned}
\]

\paragraph{Decision variables.}
\[
\begin{aligned}
&\delta_{\ell}\in\{0,1\}\ (\text{or }[0,1]\text{ if relaxed}) 
  &&\forall\,\ell\in S
  &:\text{ switch‐status (1=closed)},\\
&f_{\ell,i,j}\in\mathbb R 
  &&\forall\,(\ell,i,j)\in C
  &:\text{ artificial “flow” on arc }(\ell,i,j),\\
&\theta\in\mathbb R 
  &:&\text{ Benders‐cut auxiliary variable.}
\end{aligned}
\]

\paragraph{1. Flow–Balance (one parent per node).}
\begin{align}
\sum_{\substack{(\ell,i,j)\in C \\ j = n}} f_{\ell,i,j}
&=
\begin{cases}
-\varepsilon, 
&n \in N\setminus\{\texttt{slack\_node}\},\\
\;\ge \varepsilon\,\bigl(|N|-1\bigr),
&n = \texttt{slack\_node}
\end{cases}
&& \forall\,n\in N
\end{align}

\paragraph{2. Orientation (zero net on each physical line).}
\begin{align}
\sum_{(\ell,i,j)\in C} f_{\ell,i,j} &= 0
&& \forall\,\ell\in L
\end{align}

\paragraph{3. Switch–Propagation (flow only if switch closed).}
\begin{align}
f_{\ell,i,j} &\le \varepsilon\,|N|\,\delta_{\ell},\\
f_{\ell,i,j} &\ge -\,\varepsilon\,|N|\,\delta_{\ell}
&& \forall\,(\ell,i,j)\in C,\;\ell\in S
\end{align}

\paragraph{4. Number of Closed Switches (spanning‐tree size).}
\begin{align}
\sum_{\ell\in S} \delta_{\ell} &= |N| - |nS| - 1
\end{align}


\subsection*{Power \& Current Relation with State of Switches}

\begin{align}
    -M \delta_{ij} &\leq P_{ij}(\omega,t) \leq M \delta_{ij}
    && \forall (i,j) \in \text{Lines With Switches} \tag{4a} \\
    -M \delta_{ij} &\leq Q_{ij}(\omega,t) \leq M \delta_{ij}
    && \forall (i,j) \in \text{Lines With Switches} \tag{4b} \\
    0 &\leq I_{ij}(\omega,t) \leq M \delta_{ij}
    && \forall (i,j) \in \text{Lines With Switches} \tag{4c}
\end{align}

\begin{align}
V_i(\omega,t) - V_j(\omega,t) 
- 2(r_{ij} P_{ij}(\omega,t) + x_{ij} Q_{ij}(\omega,t)) 
+ (r_{ij}^2 + x_{ij}^2) I_{ij}(\omega,t)
+ M(1 - \delta_{ij}) &\geq 0 
\tag{4d} \\
V_i(\omega,t) - V_j(\omega,t)
- 2(r_{ij} P_{ij}(\omega,t) + x_{ij} Q_{ij}(\omega,t)) 
+ (r_{ij}^2 + x_{ij}^2) I_{ij}(\omega,t) 
- M(1 - \delta_{ij}) &\leq 0 
\tag{4f}
\end{align}
\[
\forall (i,j) \in \text{Lines With Switches}
\]

    

\subsection*{Constraints Limiting:}

\begin{align}
    V_i^{min} \leq V_{i}(\omega,t) \leq V_i^{max} 
    && \forall i \in \mathcal{N} \\
    0 \leq I_{ij}(\omega,t) \leq I^{max}_{ij} 
    && \forall i \in \mathcal{N}, \forall j \in \Delta_i \\
    V_{i}(\omega,t) = \tilde{V}_{i}(\omega,t) 
    && \forall i \in \text{Substation Nodes},\ \forall \omega \in \Omega
\end{align}

Where:

\begin{itemize}
    \item $\underline{V}_i$, $\overline{V}_i$ are lower/upper levels of voltage.
    \item $\tilde{V}_{i}(\omega,t)$ is the voltage of substation at scenario $\omega$ (imposed by external grid).
\end{itemize}

\textbf{Sets:}
\begin{itemize}
    \item $\mathcal{N}$: set of nodes
    \item $\Delta_i$: set of neighboring nodes of node $i$
    \item $\Omega$: set of scenarios
    \item $\mathcal{LS}$: set of lines with switches
    \item $\mathcal{SN}$: set of substation nodes
\end{itemize}

\vspace{1em}

\textbf{Decision Variables and Parameters:}

\begin{tabular}{|>{\bfseries}l|l|l|}
\hline
Symbol & Description & Index Domain \\
\hline
$I_{ij}(\omega,t)$ & Squared current from node $i$ to $j$ in scenario $\omega$ & $\forall i \in \mathcal{N}, j \in \Delta_i, \omega \in \Omega$ \\
$P_{ij}(\omega,t)$ & Active power flow from $i$ to $j$ in scenario $\omega$ & Same as above \\
$Q_{ij}(\omega,t)$ & Reactive power flow from $i$ to $j$ in scenario $\omega$ & Same as above \\
$V_i(\omega,t)$ & Squared voltage at node $i$ in scenario $\omega$ & $\forall i \in \mathcal{N}, \omega \in \Omega$ \\
\hline
$P_{i}(\omega,t)$ & Net consumption at node $i$ (parameter) & $\forall i \in \mathcal{N}, \omega \in \Omega$ \\
$Q_{i}(\omega,t)$ & Net reactive power at node $i$ (parameter) & Same as above \\
$P_{Gi}(\omega,t)$ & Power generated by external grid at node $i$ & $\forall i \in \text{ExternalPoints}, \omega \in \Omega$ \\
$Q_{Gi}(\omega,t)$ & Reactive power from external grid & Same as above \\
$d_{ij}$ & Binary variable for direction between $i$ and $j$ & $\forall (i,j) \in \text{LinesWithSwitches}$ \\
$\delta_{ij}$ & Binary variable for line/switch status & Same as above \\
\hline
\end{tabular}



\begin{center}
\begin{tikzpicture}[node distance=0.8cm and 0.5cm]

% Nodes
\node (start)      [startstop]                      {Start};
\node (master)     [block, below=of start]          {Master Problem (MP)};
\node (delta)      [block, below=of master]         {Get $\delta_\ell^{(k)}$};
\node (slave)      [block, below=of delta]          {Slave Problem (SP)};
\node (feas)       [decision, below=of slave]       {Feasible?};
\node (converged)  [decision, below=of feas]        {Converged?};
\node (optcut)     [block, below=of converged]      {Add Optimality Cut};
\node (opt)        [startstop, left=of converged, xshift=-3.5cm] {Optimal Solution};
\node (sp1)        [block, right=of feas, xshift=3.5cm] {Solve SP1 with Infeasibility};
\node (infcut)     [block, below=of sp1]            {Add Infeasibility Cut};
\node (stop)       [block, right=of master, xshift=4cm] {Stop};

% Arrows
\draw [arrow] (start) -- (master);
\draw [arrow] (master) -- (delta);
\draw [arrow] (delta) -- (slave);
\draw [arrow] (slave) -- (feas);

% Right branch: infeasibility
\draw [arrow] (feas.east) -- node[above] {No} (sp1.west);
\draw [arrow] (sp1) -- (infcut);
\draw [arrow] (infcut.west) -- ++(-2.3,0) |- (master.east);

% Continue downward
\draw [arrow] (feas.south) -- node[right] {Yes} (converged);
\draw [arrow] (converged.south) -- node[right] {No} (optcut);
\draw [arrow] (optcut.west) -- ++(-2.3,0) |- (master.west);

% Optimal solution
\draw [arrow] (converged.west) -- node[above] {Yes} (opt.east);

% Infeasible master
\draw [arrow] (master.east) -- node[above] {Infeasible} (stop.west);

\end{tikzpicture}
\end{center}


\newpage

\subsection*{Slave Subproblem \(\mathrm{SP}^\omega\) for each scenario \(\omega\in W\)}

\paragraph{Index sets.}
\[
\begin{aligned}
&N: \text{set of buses},\quad
L: \text{set of undirected lines},\\
&S\subseteq L: \text{lines equipped with switches},\quad
C\subseteq L\times N\times N: \text{directed candidate arcs},\\
&W: \text{set of scenarios}.
\end{aligned}
\]

\paragraph{Given from the master:} \(\delta_\ell^\ast\in\{0,1\}\) for each \(\ell\in S\).

\paragraph{Variables (per \(\omega\)):}
\[
\begin{aligned}
&v_{n}^2(\omega,t),\;
p_{ij}(\omega,t),\;
q_{ij}(\omega,t),\;
I_{ij}(\omega,t),\;
\text{(and if infeasible: slack variables }s_{vn}(\omega,t),\,s_{Iij})(\omega,t)\,.\\
\end{aligned}
\]

\paragraph{Objective.}
\[
\min_{\substack{v^2,p,q,I}}
\quad
\sum_{(i,j)\in C}\! \tfrac12\,r_{ij}\,I_{ij}(\omega,t)
\quad\longrightarrow\ 
\text{optimality cost }\mathrm{obj}^{\mathrm{feas},(k)}(\omega,t),
\]
or when infeasible
\[
\min
\;\sum_{n\in N}\!(s_{vn}^+(\omega,t) + s_{vn}^-(\omega,t))
\;+\!\sum_{(i,j)\in C} s_{Iij}(\omega,t)
\;\longrightarrow\;\mathrm{obj}^{\mathrm{infeas},(k)}(\omega,t).
\]

\paragraph{Constraints (for each \(\omega\)):}

\begin{enumerate}
  \item \textbf{Switch‐status propagation:}
  \[
    \delta_{\ell\omega} = \delta_\ell^*\,,\quad
    \forall\,\ell\in S.
  \]

  \item \textbf{Slack‐bus voltage:}
  \[
    V(\omega,t) =  V_{n}(\omega,t),\quad
    \text{if }n=\texttt{slack\_node},\quad\text{else skipped.}
  \]

  \item \textbf{Nodal active‐power balance:}
  \[
    \sum_{(i,j)\in C:\,i=n} p_{ij}(\omega,t)
    =
    \begin{cases}
       -\,P^{\mathrm{slack}}(\omega,t), & n = \texttt{slack\_node},\\
       -\,P_{n}(\omega,t),                & \text{otherwise}.
    \end{cases}
  \]

  \item \textbf{Nodal reactive‐power balance:}
  \[
    \sum_{(i,j)\in C:\,i=n}\Bigl(q_{ij}(\omega,t)-\tfrac12\,b_{ij}\,V_{i}(\omega,t)\Bigr)
    =
    \begin{cases}
       -\,Q^{\mathrm{slack}}(\omega,t), & n = \texttt{slack\_node},\\
       -\,Q_{n}(\omega,t),                & \text{otherwise}.
    \end{cases}
  \]

  \item \textbf{Branch voltage‐drop (DistFlow):}
  \[
    V_{i}(\omega,t) - V_{j}(\omega,t)
    -2\bigl(r_{ij}p_{ij}(\omega,t)+x_{ij}q_{ij}(\omega,t)\bigr)
    + (r_{ij}^2+x_{ij}^2)\,I_{ij}(\omega,t)
    \;\begin{cases}
      =0, & \ell\notin S,\\
      \ge -M_{ij}(1-\delta_{\ell}(\omega,t)),\\
      \le +M_{ij}(1-\delta_{\ell}(\omega,t)), & \ell\in S.
    \end{cases}
  \]

  \item \textbf{Rotated‐cone current constraint (no switch):}
  \[
    p_{ij}^2(\omega,t) + q_{ij}^2(\omega,t) \;\le\; I_{ij}(\omega,t)\,\frac{V_{i}(\omega,t)}{n_{ij}^2}, 
    \quad\forall\,\ell\notin S.
  \]
  If \(\ell\in S\), simply \(I_{ij}(\omega,t)=0\).

  \item \textbf{Branch power‐balance (Kirchhoff):}
  \[
    \sum_{(i,j)\in C:\,\ell=ij}
      \bigl(p_{ij}(\omega,t)-\tfrac12\,r_{ij}I_{ij}\bigr) = 0,
    \quad
    \sum_{(i,j)\in C:\,\ell=ij}
      \bigl(q_{ij}(\omega,t)-\tfrac12\,x_{ij}I_{ij}(\omega,t)\bigr) = 0.
  \]

  \item \textbf{Switch \(P/Q\) bounds (\(\ell\in S\)):}
  \[
    -M_{ij}\,\delta_{\ell}(\omega,t) \;\le\; p_{ij}(\omega,t) \;\le\; M_{ij}\,\delta_{\ell}(\omega,t), 
    \quad
    -M_{ij}\,\delta_{\ell}(\omega,t) \;\le\; q_{ij}(\omega,t) \;\le\; M_{ij}\,\delta_{\ell}(\omega,t).
  \]

  \item \textbf{Physical limits (only in optimal subproblem):}
  \[
    0 \;\le\; I_{ij}(\omega,t) \;\le\; I_{ij}^{\max}, 
    \quad
    V_{n}^{\min}(\omega,t)\!\le\!v^2_{n}(\omega,t)\!\le\!V_{n}^{\max}(\omega,t).
  \]

\end{enumerate}

\subsubsection*{Infeasible Subproblem $\mathrm{SP}_{\mathrm{infeas}}(\omega,t)$}

\paragraph{Objective (infeasibility penalties):}
\begin{equation}
\min_{V,\,p,\,q,\,I,\,s_v^\pm,\,s_I}
\quad
\sum_{n\in N}\bigl(s^+_{vn}(\omega,t) + s^-_{vn}(\omega,t)\bigr)
\;+\!\!
\sum_{(i,j)\in C} s_{Iij}(\omega,t)
\;\;\longrightarrow\;
\mathrm{obj}^{\mathrm{infeas},(k)}(\omega,t)
\end{equation}

\paragraph{Relaxed physical‐limit constraints (per \(\omega\)):}
\begin{align}
V_{n}(\omega,t) &\le  V_n^{max} \;+\; s^+_{vn}(\omega,t),
&& \forall n\in N, 
\label{ineq:volt_up_relaxed}\\
V_{n}(\omega,t) &\ge  V_n^{min} \;-\; s^-_{vn}(\omega,t),
&& \forall n\in N, 
\label{ineq:volt_low_relaxed}\\
I_{ij}(\omega,t) &\le \overline I_{ij}^{max} \;+\; s_{Iij}(\omega,t),
&& \forall (i,j)\in C, 
\label{ineq:curr_relaxed}\\
s^+_{vn}(\omega,t),\,s^-_{vn}(\omega,t),\,s_{Iij}(\omega,t)
&\ge 0,\quad 
&& \forall n\in N,\;\forall (i,j)\in C.
\end{align}

All of the network constraints
\[
\{\text{Slack‐voltage},\;\text{Power‐balances},\;\text{Voltage‐drops},\;
\text{Conic‐current},\;\text{Switch‐bounds},\ldots\}
\]
are assembled in  
\texttt{slave\_model\_constraints(model)}  
and thus appear in both the \emph{optimal} and \emph{infeasible} subproblem models. The only differences between them are considering the slack variable in the physical limitation of current and voltage 



\section*{Master Problem at Iteration \(k\)}

\begin{align*}
\min_{\;\{\theta_\omega\}_{\omega\in\Omega},\;\{\delta_\ell\}_{\ell\in S},\;\{f_{\ell,i,j}\}_{(\ell,i,j)\in C}\;} 
&\quad \sum_{\omega\in\Omega} \theta_\omega \\[0.5em]
\text{s.t.}\quad
&\underbrace{
  \sum_{\substack{(\ell,i,j)\in C \\ j = n}}
    f_{\ell,i,j}
  =
  \begin{cases}
    -\,\varepsilon,
      &n \in N\setminus\{\texttt{slack\_node}\},\\
    \ge \varepsilon\,(|N|-1),
      &n = \texttt{slack\_node},
  \end{cases}
}_{\text{(1) Flow–Balance}}
  \quad \forall\,n\in N, 
  \\[1em]
&\underbrace{
  \sum_{\substack{(\ell,i,j)\in C \\ \ell = \ell'}}
    f_{\ell,i,j}
  = 0
}_{\text{(2) Orientation}}
  \quad \forall\,\ell'\in L,
  \\[0.75em]
&\underbrace{
  -\,\varepsilon\,|N|\,\delta_\ell
  \;\le\;
    f_{\ell,i,j}
  \;\le\;
    \varepsilon\,|N|\,\delta_\ell
}_{\text{(3) Switch–Propagation}}
  \quad \forall\,(\ell,i,j)\in C,\;\ell\in S,
  \\[0.75em]
&\underbrace{
  \sum_{\ell\in S} \delta_\ell
  = |N| - |nS| - 1
}_{\text{(4) Spanning‐Tree Size}}
  \\[1em]
&\underbrace{
  \theta_\omega 
  \;\ge\;
    \varphi_{\omega}^{(m)}
  \;+\;
    \sum_{\ell\in S}
      \pi_{\ell\omega}^{(m)}\,
      \bigl(\delta_\ell - \delta_\ell^{(m)}\bigr)
}_{\substack{\text{Optimality cuts}\\m=1,\dots,k-1}}
  \quad \forall\,\omega\in\Omega,
  \\[0.75em]
&\underbrace{
  0 
  \;\ge\;
    \psi_{\omega}^{(m)}
  \;+\;
    \sum_{\ell\in S}
      \rho_{\ell\omega}^{(m)}\,
      \bigl(\delta_\ell - \delta_\ell^{(m)}\bigr)
}_{\substack{\text{Infeasibility cuts}\\m=1,\dots,k-1}}
  \quad \forall\,\omega\in\Omega,
  \\[1em]
&\delta_\ell\in\{0,1\},\;\forall\,\ell\in S,
\quad
f_{\ell,i,j}\in\mathbb R,\;\forall\,(\ell,i,j)\in C,
\quad
\theta_\omega\in\mathbb R,\;\forall\,\omega\in\Omega.
\end{align*}

\bigskip

\noindent\textbf{Notes on the Benders‐cut notation:}
- \(\varphi_{\omega}^{(m)},\,\pi_{\ell\omega}^{(m)}\) are the dual‐derived intercept and slope coefficients from the \emph{optimality} subproblem for scenario \(\omega\) at previous iteration \(m\).  
- \(\psi_{\omega}^{(m)},\,\rho_{\ell\omega}^{(m)}\) likewise come from an \emph{infeasibility} cut for scenario \(\omega\), iteration \(m\).  
- \(\delta_\ell^{(m)}\) is the value of \(\delta_\ell\) at iteration \(m\).  






\end{document}

